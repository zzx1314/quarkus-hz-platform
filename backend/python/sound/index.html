<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebSocket è¯­éŸ³è¯†åˆ« Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
        }
        button {
            font-size: 16px;
            padding: 10px 20px;
            margin-right: 10px;
        }
        #status {
            margin-top: 15px;
            font-weight: bold;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<h2>ğŸ™ï¸ WebSocket è¯­éŸ³è¯†åˆ«</h2>

<button id="start">å¼€å§‹å½•éŸ³</button>
<button id="stop" disabled>åœæ­¢å¹¶å‘é€</button>

<div id="status">çŠ¶æ€ï¼šæœªè¿æ¥</div>
<pre id="result"></pre>

<script>
/* ==========================
   é…ç½®
========================== */
const SERVER_IP = "192.168.41.227";
const SERVER_PORT = 8000;
const WS_URL = `ws://${SERVER_IP}:${SERVER_PORT}/ws`;
const TARGET_SAMPLE_RATE = 16000;

/* ==========================
   å…¨å±€å˜é‡
========================== */
let audioContext;
let mediaStream;
let sourceNode;
let processorNode;
let ws;
let audioChunks = [];

/* ==========================
   UI å…ƒç´ 
========================== */
const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");

/* ==========================
   äº‹ä»¶ç»‘å®š
========================== */
startBtn.onclick = startRecording;
stopBtn.onclick = stopRecording;

/* ==========================
   å¼€å§‹å½•éŸ³
========================== */
async function startRecording() {
    resultEl.textContent = "";
    audioChunks = [];

    statusEl.textContent = "çŠ¶æ€ï¼šè¿æ¥ WebSocket...";
    ws = new WebSocket(WS_URL);
    ws.binaryType = "arraybuffer";

    ws.onopen = async () => {
        statusEl.textContent = "çŠ¶æ€ï¼šå½•éŸ³ä¸­...";
        startBtn.disabled = true;
        stopBtn.disabled = false;

        audioContext = new AudioContext({ sampleRate: TARGET_SAMPLE_RATE });
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        sourceNode = audioContext.createMediaStreamSource(mediaStream);

        processorNode = audioContext.createScriptProcessor(4096, 1, 1);
        processorNode.onaudioprocess = e => {
            const inputData = e.inputBuffer.getChannelData(0);
            audioChunks.push(new Float32Array(inputData));
        };

        sourceNode.connect(processorNode);
        processorNode.connect(audioContext.destination);
    };

    ws.onerror = () => {
        statusEl.textContent = "çŠ¶æ€ï¼šWebSocket è¿æ¥å¤±è´¥";
    };
}

/* ==========================
   åœæ­¢å½•éŸ³å¹¶å‘é€
========================== */
function stopRecording() {
    statusEl.textContent = "çŠ¶æ€ï¼šå¤„ç†éŸ³é¢‘å¹¶å‘é€...";

    processorNode.disconnect();
    sourceNode.disconnect();
    mediaStream.getTracks().forEach(t => t.stop());

    // åˆå¹¶ Float32Array
    let totalLength = audioChunks.reduce((sum, arr) => sum + arr.length, 0);
    let audioData = new Float32Array(totalLength);
    let offset = 0;

    for (let chunk of audioChunks) {
        audioData.set(chunk, offset);
        offset += chunk.length;
    }

    // å‘é€éŸ³é¢‘æ•°æ®
    ws.send(audioData.buffer);

    // å‘é€ EOF
    ws.send("EOF");

    ws.onmessage = e => {
        const data = JSON.parse(e.data);
        resultEl.textContent = "è¯†åˆ«ç»“æœï¼š\n" + data.text;
        statusEl.textContent = "çŠ¶æ€ï¼šè¯†åˆ«å®Œæˆ";
        startBtn.disabled = false;
        stopBtn.disabled = true;
    };

    ws.onclose = () => {
        statusEl.textContent = "çŠ¶æ€ï¼šè¿æ¥å·²å…³é—­";
    };
}
</script>

</body>
</html>
