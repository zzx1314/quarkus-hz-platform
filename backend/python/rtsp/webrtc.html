<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>MediaMTX WebRTC Player</title>

<style>
  body {
    background: #111;
    color: #eee;
    text-align: center;
    font-family: Arial, sans-serif;
    padding-top: 30px;
  }
  video {
    width: 80%;
    max-width: 900px;
    background: #000;
    margin-top: 20px;
  }
  button {
    padding: 8px 20px;
    margin: 10px;
    cursor: pointer;
  }
  pre {
    text-align: left;
    max-width: 900px;
    margin: 20px auto;
    color: #0f0;
    background: #222;
    padding: 10px;
    border-radius: 6px;
    height: 260px;
    overflow-y: auto;
  }
</style>
</head>

<body>

<h2>MediaMTX WebRTC æ’­æ”¾</h2>

<button id="playBtn">æ’­æ”¾ / é‡æ–°æ‹‰æµ</button>
<button id="stopBtn">åœæ­¢</button>

<!-- muted æ˜¯ WebRTC è‡ªåŠ¨æ’­æ”¾çš„å…³é”® -->
<video id="video" autoplay playsinline muted controls></video>

<pre id="log"></pre>

<script>
const WHEP_URL = "http://192.168.41.227:8889/live/mystream/whep";

const video = document.getElementById("video");
const logEl = document.getElementById("log");

function log(...args) {
  logEl.textContent += args.join(" ") + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

let pc = null;

/* =========================
   åœæ­¢å¹¶æ¸…ç† WebRTC
   ========================= */
function stopPlay() {
  if (!pc) return;

  log("åœæ­¢ WebRTC æ’­æ”¾");

  pc.ontrack = null;
  pc.oniceconnectionstatechange = null;
  pc.onconnectionstatechange = null;

  pc.close();
  pc = null;

  video.pause();
  video.srcObject = null;
}

/* =========================
   å¯åŠ¨ WebRTC æ’­æ”¾
   ========================= */
async function startPlay() {
  log("å¼€å§‹ WebRTC æ’­æ”¾ (MediaMTX)");

  pc = new RTCPeerConnection();

  pc.ontrack = async (e) => {
    log("æ”¶åˆ°è§†é¢‘æµ");
    if (!video.srcObject) {
      video.srcObject = e.streams[0];
      try {
        await video.play();
        log("video.play() æˆåŠŸ");
      } catch (err) {
        log("video.play() å¤±è´¥:", err);
      }
    }
  };

  pc.oniceconnectionstatechange = () => {
    log("ICE çŠ¶æ€:", pc.iceConnectionState);
  };

  pc.onconnectionstatechange = () => {
    log("è¿æ¥çŠ¶æ€:", pc.connectionState);

    // å¦‚æœæ–­å¼€ï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨é‡è¿
    if (pc.connectionState === "failed") {
      log("è¿æ¥å¤±è´¥ï¼Œè‡ªåŠ¨é‡è¿ä¸­...");
      stopPlay();
      startPlay();
    }
  };

  pc.addTransceiver("video", { direction: "recvonly" });

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  log("å‘é€ SDP Offer â†’ MediaMTX");

  const res = await fetch(WHEP_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });

  if (!res.ok) {
    throw new Error("WHEP è¯·æ±‚å¤±è´¥: " + res.status);
  }

  const answerSDP = await res.text();

  await pc.setRemoteDescription({
    type: "answer",
    sdp: answerSDP
  });

  log("WebRTC æ’­æ”¾ä¸­ ğŸ‰");
}

/* =========================
   æŒ‰é’®ç»‘å®š
   ========================= */
document.getElementById("playBtn").onclick = async () => {
  stopPlay();
  try {
    await startPlay();
  } catch (err) {
    log("æ’­æ”¾å¤±è´¥:", err);
    stopPlay();
  }
};

document.getElementById("stopBtn").onclick = () => {
  stopPlay();
};
</script>

</body>
</html>
